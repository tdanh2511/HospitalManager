using InpatientManagementSystem.BUS;
using InpatientManagementSystem.DTO;
using System;
using System.Collections.Generic;
using System.Windows.Forms;

namespace Quan_li_benh_vien
{
    public partial class FormBenhNhan : Form
    {
        private BenhNhanBUS benhNhanBUS = new BenhNhanBUS();
        private string maBenhNhanDangChon = "";

        public FormBenhNhan()
        {
            InitializeComponent();
        }

        private void FormBenhNhan_Load(object sender, EventArgs e)
        {
            LoadDanhSach();
            ClearForm();
        }

        // Thêm bệnh nhân
        private void btnThem_Click(object sender, EventArgs e)
        {
            try
            {
                // Tạo object BenhNhan từ dữ liệu người dùng nhập
                BenhNhanDTO bn = new BenhNhanDTO
                {
                    CCCD = txtCCCD.Text.Trim(),
                    HoTen = txtHoTen.Text.Trim(),
                    NgaySinh = dtpNgaySinh.Value,
                    GioiTinh = cbGioiTinh.Text,
                    SoDienThoai = txtSoDienThoai.Text.Trim(),
                    BHYT = txtBHYT.Text.Trim(),
                    DiaChi = txtDiaChi.Text.Trim()
                };

                bool result = benhNhanBUS.ThemBenhNhan(bn);

                if (result)
                {
                    MessageBox.Show("Thêm bệnh nhân thành công!", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    LoadDanhSach();
                    ClearForm();
                }
                else
                {
                    MessageBox.Show("Thêm bệnh nhân thất bại!", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi: " + ex.Message, "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // Sửa bệnh nhân
        private void btnSua_Click(object sender, EventArgs e)
        {
            try
            {
                if (string.IsNullOrEmpty(maBenhNhanDangChon))
                {
                    MessageBox.Show("Vui lòng chọn bệnh nhân cần sửa!", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                BenhNhanDTO bn = new BenhNhanDTO
                {
                    MaBenhNhan = maBenhNhanDangChon,
                    CCCD = txtCCCD.Text.Trim(),
                    HoTen = txtHoTen.Text.Trim(),
                    NgaySinh = dtpNgaySinh.Value,
                    GioiTinh = cbGioiTinh.Text,
                    SoDienThoai = txtSoDienThoai.Text.Trim(),
                    BHYT = txtBHYT.Text.Trim(),
                    DiaChi = txtDiaChi.Text.Trim()
                };

                bool result = benhNhanBUS.CapNhatBenhNhan(bn);

                if (result)
                {
                    MessageBox.Show("Cập nhật bệnh nhân thành công!", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    LoadDanhSach();
                    ClearForm();
                }
                else
                {
                    MessageBox.Show("Cập nhật bệnh nhân thất bại!", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi: " + ex.Message, "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // Xóa bệnh nhân
        private void btnXoa_Click(object sender, EventArgs e)
        {
            try
            {
                if (string.IsNullOrEmpty(maBenhNhanDangChon))
                {
                    MessageBox.Show("Vui lòng chọn bệnh nhân cần xóa!", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                DialogResult dialogResult = MessageBox.Show(
                    "Bạn có chắc chắn muốn xóa bệnh nhân này?",
                    "Xác nhận xóa",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Question);

                if (dialogResult == DialogResult.Yes)
                {
                    bool result = benhNhanBUS.XoaBenhNhan(maBenhNhanDangChon);

                    if (result)
                    {
                        MessageBox.Show("Xóa bệnh nhân thành công!", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        LoadDanhSach();
                        ClearForm();
                    }
                    else
                    {
                        MessageBox.Show("Xóa bệnh nhân thất bại!", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi: " + ex.Message, "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // Tìm kiếm bệnh nhân
        private void btnTimKiem_Click(object sender, EventArgs e)
        {
            try
            {
                string keyword = txtTimKiem.Text.Trim();
                List<BenhNhanDTO> danhSach = benhNhanBUS.TimKiemBenhNhan(keyword);

                dgvBenhNhan.DataSource = null;
                dgvBenhNhan.DataSource = danhSach;

                CustomizeDataGridView();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi tìm kiếm: " + ex.Message, "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // Load lại toàn bộ danh sách
        private void btnLamMoi_Click(object sender, EventArgs e)
        {
            LoadDanhSach();
            ClearForm();
            txtTimKiem.Clear();
        }

        // Load danh sách bệnh nhân vào DataGridView
        private void LoadDanhSach()
        {
            try
            {
                List<BenhNhanDTO> danhSach = benhNhanBUS.LayDanhSachBenhNhan();
                dgvBenhNhan.DataSource = null;
                dgvBenhNhan.DataSource = danhSach;

                CustomizeDataGridView();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi load danh sách: " + ex.Message, "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // Tùy chỉnh hiển thị DataGridView
        private void CustomizeDataGridView()
        {
            if (dgvBenhNhan.Columns.Count > 0)
            {
                dgvBenhNhan.Columns["MaBenhNhan"].HeaderText = "Mã BN";
                dgvBenhNhan.Columns["MaBenhNhan"].Width = 80;

                dgvBenhNhan.Columns["CCCD"].HeaderText = "CCCD";
                dgvBenhNhan.Columns["CCCD"].Width = 120;

                dgvBenhNhan.Columns["HoTen"].HeaderText = "Họ và tên";
                dgvBenhNhan.Columns["HoTen"].Width = 150;

                dgvBenhNhan.Columns["NgaySinh"].HeaderText = "Ngày sinh";
                dgvBenhNhan.Columns["NgaySinh"].Width = 100;
                dgvBenhNhan.Columns["NgaySinh"].DefaultCellStyle.Format = "dd/MM/yyyy";

                dgvBenhNhan.Columns["GioiTinh"].HeaderText = "Giới tính";
                dgvBenhNhan.Columns["GioiTinh"].Width = 80;

                dgvBenhNhan.Columns["SoDienThoai"].HeaderText = "Số điện thoại";
                dgvBenhNhan.Columns["SoDienThoai"].Width = 100;

                dgvBenhNhan.Columns["BHYT"].HeaderText = "Mã BHYT";
                dgvBenhNhan.Columns["BHYT"].Width = 120;

                dgvBenhNhan.Columns["DiaChi"].HeaderText = "Địa chỉ";
                dgvBenhNhan.Columns["DiaChi"].AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill;
            }
        }

        // Khi click vào dòng trong DataGridView
        private void dgvBenhNhan_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            try
            {
                if (e.RowIndex >= 0)
                {
                    DataGridViewRow row = dgvBenhNhan.Rows[e.RowIndex];

                    maBenhNhanDangChon = row.Cells["MaBenhNhan"].Value.ToString();
                    txtCCCD.Text = row.Cells["CCCD"].Value.ToString();
                    txtHoTen.Text = row.Cells["HoTen"].Value.ToString();
                    dtpNgaySinh.Value = Convert.ToDateTime(row.Cells["NgaySinh"].Value);
                    cbGioiTinh.Text = row.Cells["GioiTinh"].Value.ToString();
                    txtSoDienThoai.Text = row.Cells["SoDienThoai"].Value.ToString();
                    txtBHYT.Text = row.Cells["BHYT"].Value.ToString();
                    txtDiaChi.Text = row.Cells["DiaChi"].Value.ToString();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi: " + ex.Message, "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // Xóa dữ liệu trong form
        private void ClearForm()
        {
            maBenhNhanDangChon = "";
            txtCCCD.Clear();
            txtHoTen.Clear();
            txtSoDienThoai.Clear();
            txtBHYT.Clear();
            txtDiaChi.Clear();
            dtpNgaySinh.Value = DateTime.Now;
            cbGioiTinh.SelectedIndex = -1;
            txtCCCD.Focus();
        }
    }
}
